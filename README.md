## 시스템 개요 

지하주차장 침수 2차피해 방지 센서 시스템은 다음 두가지 데이터 소스를 통합하여 위험도를 분석한다.

1. 물 센서 높이(아두이노) : 지하주차장에 설치된 리드 스위치 센서로 물의 높이 감지
2. 기상청 API(Python) : 실시간 강수량 데이터를 수집하여 CSV 파일에 저장

두 데이터를 결합하여 실시간 위험도를 계산하고, OLED 디스플레이에 표시한다.

## 하드웨어 구성

- 리드스위치 3개 : 물 높이 감지용
  - GREEN (Pin 4) : 발목 정도 물 높이 감지
  - YELLOW (Pin 9) : 다리까지 물 높이 감지
  - RED (Pin 13) : 침수 직전 물 높이 감지
- LED 3개 : 센서 상태 표시
  - GREEN LED (Pin 3)
  - YELLOW LED (Pin 7)
  - RED LED (Pin 12)
- OLED 디스플레이 (SSD1306) : 위험도 정보 표시
- 자석 : 부력에 의해 물과 함께 떠오르며 센서를 켬

### 센서 작동 원리
- 물이 차면서 자석이 부력에 의해 떠오름
- 자석이 리드 스위치에 접근하면 센서가 활성화됨
- 센서는 토글 방식으로 동작 (한 번 접촉하면 ON, 다시 접촉 하면 OFF)


## 소프트웨어 구조

### 통신 프로토콜

#### 아두이노 → python
SENSOR:GREEN:YELLOW:RED
예: SENSOR:1:0:1  (GREEN=ON, YELLOW=OFF, RED=ON)

#### python → 아두이노
DATA:WATER_LEVEL:RAINFALL:RISK_LEVEL
예: DATA:YELLOW:100.5:DANGER

## 위험도(RISK) 분석 로직
<대전제>
1. 센서 우선 : 물 높이 센서가 위험도 결정 주요 기준
2. 강수량 보조 : 강수량은 침수 속도 예측을 위한 보조 지표


### 센서 기반 기본 위험도
| 물 높이 |   의미   | 기본 위험도 |

--------------------------------

| NONE  |  물 없음  |   SAFE   |

| GREEN | 발목 정도 |  CAUTION  |

| YELLOW| 다리까지  |  WARNING  |

|  RED  | 침수 직전 |   DANGER  |

### 강수량 기준
차수벽 있기 때문에 30mm/h까지는 영향이 없도로 했음.
| 강수량 |   분류   | 영향 |

--------------------------------

| 30mm/h 미만  |    |   영향 없음 (센서기반 위험도 유지)   |

| 30-50mm/h | 많은 비 |  1단계 상향 |

| 50-100mm/h | 매우 많은 비  |  1단계 상향  |

|  100mm/h 이상  | 극한 호우 |   2단계 상향  |


### 위험도 조정 규칙
#### 1. 극한 호우 (100mm/h 이상)
- 위험도 2단계 상향
- 예 : GREEN + 100mm/h → CAUTION → DANGER
- 예 : YELLOW + 100mm/h → WARNING → DANGER

#### 2. 매우 많은 비 (50-100mm/h)
- 위험도 1단계 상향
- 예 : GREEN + 50mm/h → CAUTION → WARNING
- 예 : YELLOW + 50mm/h → WARNING → DANGER

#### 3. 많은 비 (30-50mm/h)
- 위험도 1단계 상향
- 예 : GREEN + 30mm/h → CAUTION → WARNING
- 예 : YELLOW + 30mm/h → WARNING → DANGER

#### 4. 30mm/h 미만
- 위험도 조정 없음(그대로 유지)
- 차수벽으로 인해 조정 하지 않음(1차적으로 막아줄 것이기 때문)

### 위험도 레벨
| 레벨 | 의미 | 조치 |
| SAFE | 안전 | 정상 운영 |
| CAUTION | 주의 | 모니터링 강화 |
| DANGER | 위험 | 즉시 대피 |


### 1. 설치 및 실행
cd kma_simple
source .venv/bin/activate #가상환경 활성화(있으면.. 없으면 가상환경 만들어줘야함)
pip install -r requirements.txt


### 2. 아두이노 코드 업로드
1. 아두이노 IDE에서 다운 받은 arduino/arduino.ino 열기
2. 보드와 포트 선택
3. 업로드 버튼 클릭
4. 실행했을대 시리얼 모니터는 닫아둬야함.(Python에서  시리어 포트를 사용할 것)

### 3. Python 스크립트 실행
cd kma_simple
python kma_simple.py

### 4. 종료
q 엔터


## 동작 방식

### 데이터 수집 주기
1. 기상청 데이터 : 발표시각이 갱신될 때마다 자동 수집(대략 30분 정도 텀)
2. 센서 데이터 : 아두이노가 2초마다 전송, 센서 정보 변경 즉시 전송(ex. green led → yellow led)
3. 위험도 계산 :
    - 센서 변경 시 즉시
    - 기상청 갱신시 즉시
    - 그 외 10초 마다 갱신
  
### 디스플레이 정보

OLED 디스플레이에 아래와 같은 정보가 표시됨.

WATER: YELLOW          # 물 높이 레벨
RAIN: 100.0mm/h        # 현재 강수량
RISK: DANGER           # 위험도
G:ON Y:ON R:OFF        # 센서 상태
Update: 2s ago         # 마지막 업데이트 시간

### 로그 출력

#### 정상 동작 시 

센서 초기화] G:False Y:False R:False  (첫 실행 시)

[상태] 물 높이: NONE, 강수량: 0.0mm/h, 위험도: SAFE  (10초마다)

[센서] G:True Y:False R:False → 변경 감지
[센서 변경] 물 높이: GREEN, 강수량: 0.0mm/h, 위험도: CAUTION

[기상청 갱신] 물 높이: GREEN, 강수량: 5.0mm/h, 위험도: CAUTION

## 주요 기능

### 실시간 모니터링
- 센서 상태 실시간 감지
- 기상청 데이터 자동 수집
- 위험도 자동 계산

### 데이터 저장
- 기상청 데이터 CSV 파일 저장
- timestamp, 좌표, 기온, 강수량, 습도, 풍속 기록
  

### 통신 안정성
- 시리얼 통신 자동 포트 감지
- Bluetooth 포트 자동 제외
- 연결 실패 시 경고 메세지

## 문제 해결

### 아두이노 연결 실패
- 아두이노가 USB로 연결되어 있는지 확인
- 아두이노 IDE의 시리얼 모니터가 닫혀있는지 확인
- 포트가 올바른지 확인 (`/dev/cu.usbmodem...` 또는 `/dev/tty.usbmodem...`)

### 센서 데이터 수신 안됨
- 아두이노 코드가 최신 버전으로 업로드되었는지 확인
- 아두이노를 재부팅
- Python 스크립트 재시작

### 위험도가 변경되지 않음
- 센서가 실제로 토글되었는지 확인 (LED 확인)
- 로그에서 `[센서 변경]` 메시지 확인
- 아두이노 디스플레이 확인


